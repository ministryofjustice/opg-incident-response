{% extends "govuk_base.html" %}
{% load opg_response %}
{% load unslackify %}

{% block title %}
    {{ incident.report | unslackify }} â€” OPG Incident Response
{% endblock %}

{% block content %}
    <h1 class="govuk-heading-xl">{{ incident.report | unslackify }}</h1>

    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">
            <dl class="govuk-summary-list">
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">
                        Summary
                    </dt>
                    <dd class="govuk-summary-list__value">
                        {{ incident.summary | unslackify }}
                    </dd>
                    <dd class="govuk-summary-list__actions"></dd>
                </div>
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">
                        Impact
                    </dt>
                    <dd class="govuk-summary-list__value">
                        {{ incident.impact | unslackify }}
                    </dd>
                    <dd class="govuk-summary-list__actions"></dd>
                </div>
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">
                        Reporter
                    </dt>
                    <dd class="govuk-summary-list__value">
                        {{ incident.reporter.full_name }}
                    </dd>
                    <dd class="govuk-summary-list__actions">
                        <a class="govuk-link" href="slack://user?team=T02DYEB3A&amp;id={{ incident.reporter.external_id }}">
                            Slack
                        </a>
                    </dd>
                </div>
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">
                        Lead
                    </dt>
                    <dd class="govuk-summary-list__value">
                        {{ incident.lead.full_name }}
                    </dd>
                    <dd class="govuk-summary-list__actions">
                        <a class="govuk-link" href="slack://user?team=T02DYEB3A&amp;id={{ incident.reporter.external_id }}">
                            Slack
                        </a>
                    </dd>
                </div>
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">
                        Start time
                    </dt>
                    <dd class="govuk-summary-list__value">
                        {{ incident.start_time | date:"j F Y, g:iA" }}
                        ({{ incident.start_time | timesince }} ago)
                    </dd>
                    <dd class="govuk-summary-list__actions"></dd>
                </div>
                <div class="govuk-summary-list__row">
                    <dt class="govuk-summary-list__key">
                        Report time
                    </dt>
                    <dd class="govuk-summary-list__value">
                        {{ incident.report_time | date:"j F Y, g:iA" }}
                        ({{ incident.start_time | timesince }} ago)
                    </dd>
                    <dd class="govuk-summary-list__actions"></dd>
                </div>
            </dl>

            <div class="govuk-form-group">
                <fieldset class="govuk-fieldset">
                    <legend class="govuk-fieldset__legend govuk-fieldset__legend--m">
                        <h2 class="govuk-heading-l">Actions</h2>
                    </legend>
                    <div class="govuk-checkboxes govuk-checkboxes--small">
                        {% for action in actions %}
                            <div class="govuk-checkboxes__item">
                                <input class="govuk-checkboxes__input" id="action-{{ action.id }}" name="action[{{action.id}}]" type="checkbox">
                                <label class="govuk-label govuk-checkboxes__label" for="action-{{ action.id }}">
                                    {{ action.details | slack_format | unslackify | safe }}
                                </label>
                            </div>
                        {% endfor %}
                    </div>
                </fieldset>
            </div>

            <h2 class="govuk-heading-l">Timeline</h2>

            <ul class="govuk-list govuk-list--bullet">
                {% for event in events %}
                    <li>
                        {{event.author.display_name}} at <strong>{{ event.timestamp | date:"j F Y, g:iA" }}</strong>
                        <p>{{ event.text | unslackify | slack_format | safe }}</p>
                    </li>
                {% endfor %}
            </ul>
        </div>

        <div class="govuk-grid-column-one-third">
            {% if incident.status_text == "resolved" %}
                <p class="govuk-body">Status: <strong class="govuk-tag">{{ incident.status_text|upper }}</strong></p>
                <p class="govuk-body">Severity: <strong class="govuk-tag govuk-tag--grey">{{ incident.severity_text }}</strong></p>
            {% else %}
                <p class="govuk-body">Status: <strong class="govuk-tag govuk-tag--red">{{ incident.status_text|upper }}</strong></p>
                <p class="govuk-body">Severity: <strong class="govuk-tag">{{ incident.severity_text }}</strong></p>
            {% endif %}

            {% if incident.comms_channel %}
            <p class="govuk-body">
                <a class="govuk-link" href="slack://channel?team=T02DYEB3A&amp;id={{ incident.comms_channel.channel_id }}">
                    #{{ incident.comms_channel.channel_name }}
                </a>
                on Slack
            </p>
            {% endif %}

            <h2 class="govuk-heading-m">Participants</h2>
            <ul class="govuk-list govuk-list--bullet">
                {% for user in user_stats %}
                    <li>{{ user.user.full_name }} ({{ user.message_count }})</li>
                {% endfor %}
            </ul>
        </div>
    </div>

{% endblock %}
